{% extends "base.html" %}
{% block title %}Import-Vorschau{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>Import-Vorschau</h1>

  <form method="post">
    {% for account, rows in groups.items() %}
      <h2 class="mt-5">{{ account }}</h2>
      <table class="table-excel">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Art</th>
            <th>Buchungstext</th>
            <th>Begünstigter/Zahlungspflichtiger</th>
            <th>Verwendungszweck</th>
            <th>Buchung</th>
            <th class="text-end">Betrag</th>
            <th>Währung</th>
            <th>Kategorie</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.art or '–' }}</td>
            <td>{{ r.buchungstext or '–' }}</td>
            <td>{{ r.beguenstigter or '–' }}</td>
            <td>{{ r.verwendungszweck or '–' }}</td>
            <td>{{ r.buchung|datum_de }}</td>
            <td class="text-end">{{ r.betrag|currency }}</td>
            <td>{{ r.waehrung or '–' }}</td>

            <td>
              {# 1. Ermitteln des Default-Namens #}
              {% set default_name = (categories
                    | selectattr('id', 'equalto', r.default_kat_id)
                    | map(attribute='name')
                    | first) or '' %}
            
              {# 2. Input-Feld, das auf die Datalist verweist #}
              <input
                type="text"
                name="category_{{ r.id }}"
                list="category-list-{{ r.id }}"
                class="form-control form-control-sm"
                placeholder="–"
                value="{{ default_name }}"
              />
              {# 3. Datalist mit allen Kategorien #}
              <datalist id="category-list-{{ r.id }}">
                {% for c in categories %}
                  <option value="{{ c.name }}"></option>
                {% endfor %}
              </datalist>
            </td>            
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}

    <button type="submit" class="btn btn-primary mt-3">Kategorien speichern</button>
    <a href="{{ url_for('importer.upload') }}" class="btn btn-secondary mt-3 ms-2">
      &laquo; Neu Import
    </a>
  </form>
</div>
{% endblock %}
